pipeline {
    agent any

    environment {
        // --- 1. KONFIGURASI NAMA IMAGE & REGISTRY ---
        // Pastikan ini sama persis dengan URL Login Server di Access Keys Azure
        REGISTRY_URL   = 'tambalfinderr.azurecr.io'
        IMAGE_NAME     = 'tambalfinder'
        
        // ID Credential yang kamu buat di Jenkins (harus sama persis huruf besar/kecilnya)
        DOCKER_CRED_ID = 'TambalFinderr'

        // --- 2. KONFIGURASI TARGET DEPLOY ---
        // Cek di Azure Portal > App Services > Nama Web App kamu
        WEBAPP_NAME    = 'TambalFinder'      
        
        // Cek di Azure Portal > Resource groups > Nama RG kamu
        RESOURCE_GROUP = 'RG-TambalFinder-2026'
    }

    stages {
        stage('Checkout Code') {
            steps {
                // Mengambil kodingan terbaru dari GitHub
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo '--- Mulai Membangun Image ---'
                    // Kita pakai tag 'latestjens' biar konsisten
                    bat "docker build -t %REGISTRY_URL%/%IMAGE_NAME%:latestjens ."
                }
            }
        }

        stage('Login to ACR') {
            steps {
                script {
                    echo '--- Login ke Azure Container Registry ---'
                    // Mengambil username & password dari Jenkins Credentials
                    withCredentials([usernamePassword(credentialsId: DOCKER_CRED_ID, usernameVariable: 'ACR_USER', passwordVariable: 'ACR_PASS')]) {
                        bat "docker login %REGISTRY_URL% -u %ACR_USER% -p %ACR_PASS%"
                    }
                }
            }
        }

        stage('Push Image') {
            steps {
                script {
                    echo '--- Mengirim Image ke Cloud (ACR) ---'
                    bat "docker push %REGISTRY_URL%/%IMAGE_NAME%:latestjens"
                }
            }
        }

        stage('Deploy to Azure Web App') {
            steps {
                script {
                    echo "--- Memulai Deployment ke Web App ---"
                    
                    // LANGKAH PENTING:
                    // Kita tidak pakai 'az account set' lagi supaya tidak error salah ID.
                    // Jenkins akan otomatis memakai akun dari hasil 'az login' yang kamu lakukan di CMD server.

                    // 1. Beritahu Web App untuk menarik image terbaru dari ACR
                    bat """
                        az webapp config container set --name %WEBAPP_NAME% --resource-group %RESOURCE_GROUP% --docker-custom-image-name %REGISTRY_URL%/%IMAGE_NAME%:latestjens --docker-registry-server-url https://%REGISTRY_URL%
                    """

                    // 2. Restart Web App supaya perubahan langsung terlihat
                    echo "--- Merestart Web App ---"
                    bat "az webapp restart --name %WEBAPP_NAME% --resource-group %RESOURCE_GROUP%"
                }
            }
        }
    }

    post {
        always {
            echo '--- Membersihkan Sisa Build ---'
            // Logout dan hapus image di laptop agar harddisk tidak penuh
            bat "docker logout %REGISTRY_URL%"
            bat "docker rmi %REGISTRY_URL%/%IMAGE_NAME%:latestjens || exit 0"
        }
    }
}
