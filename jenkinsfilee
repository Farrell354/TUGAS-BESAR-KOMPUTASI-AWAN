pipeline {
    agent any

    environment {
        // --- KONFIGURASI ACR ---
        REGISTRY_URL = 'tambalfinderr.azurecr.io'
        IMAGE_NAME   = 'tambalfinder'
        // Credential ID dari Jenkins untuk Login Docker
        DOCKER_CRED_ID = 'TambalFinderr'

        // --- KONFIGURASI AZURE WEB APP (BARU) ---
        // Masukkan nama Web App dan Resource Group Azure Anda di sini
        WEBAPP_NAME    = 'TambalFinder'      
        RESOURCE_GROUP = 'RG-TambalFinder-2026'
        SUBSCRIPTION_ID = 'cc1e4621-be06-45d7-b92f-40f5f52a97e4'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo '--- Building Docker Image ---'
                    // Build dengan tag 'latestjens' dan nomor build
                    bat "docker build -t %REGISTRY_URL%/%IMAGE_NAME%:latestjens ."
                    bat "docker build -t %REGISTRY_URL%/%IMAGE_NAME%:%BUILD_NUMBER% ."
                }
            }
        }

        stage('Login to ACR') {
            steps {
                script {
                    echo '--- Logging in to Azure Container Registry ---'
                    withCredentials([usernamePassword(credentialsId: DOCKER_CRED_ID, usernameVariable: 'ACR_USER', passwordVariable: 'ACR_PASS')]) {
                        bat "docker login %REGISTRY_URL% -u %ACR_USER% -p %ACR_PASS%"
                    }
                }
            }
        }

        stage('Push Image') {
            steps {
                script {
                    echo '--- Pushing Image to ACR ---'
                    bat "docker push %REGISTRY_URL%/%IMAGE_NAME%:latestjens"
                    bat "docker push %REGISTRY_URL%/%IMAGE_NAME%:%BUILD_NUMBER%"
                }
            }
        }

        // --- STAGE BARU: DEPLOY KE AZURE WEB APP ---
        stage('Deploy to Azure Web App') {
            steps {
                script {
                    echo "Triggering Azure Web App deployment..."
                    
                    // Kita menggunakan 'bat' karena agent Anda Windows
                    // Pastikan Azure CLI (az) sudah terinstall di server Jenkins
                    
                    // 1. Set Subscription (Penting jika punya banyak akun)
                    bat "az account set --subscription %SUBSCRIPTION_ID%"

                    // 2. Update Web App supaya menarik image terbaru (latestjens)
                    // Kita pakai 'latestjens' agar sesuai dengan yang baru saja di-push
                    bat "az webapp config container set --name %WEBAPP_NAME% --resource-group %RESOURCE_GROUP% --container-image-name %REGISTRY_URL%/%IMAGE_NAME%:latestjens"

                    // 3. Restart Web App agar perubahan efektif
                    bat "az webapp restart --name %WEBAPP_NAME% --resource-group %RESOURCE_GROUP%"
                }
            }
        }
    }

    post {
        always {
            // Bersihkan image lokal untuk hemat space
            bat "docker logout %REGISTRY_URL%"
            bat "docker rmi %REGISTRY_URL%/%IMAGE_NAME%:latestjens || exit 0"
            bat "docker rmi %REGISTRY_URL%/%IMAGE_NAME%:%BUILD_NUMBER% || exit 0"
        }
    }
}
