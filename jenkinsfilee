pipeline {
    agent any

    environment {
        // --- 1. KONFIGURASI NAMA IMAGE & REGISTRY ---
        // Pastikan ini sama persis dengan URL Login Server di Access Keys Azure
        REGISTRY_URL   = 'tambalfinderr.azurecr.io'
        IMAGE_NAME     = 'tambalfinder'
        
        // ID Credential yang kamu buat di Jenkins (harus sama persis huruf besar/kecilnya)
        DOCKER_CRED_ID = 'TambalFinderr'

        // --- 2. KONFIGURASI TARGET DEPLOY ---
        // Cek di Azure Portal > App Services > Nama Web App kamu
        WEBAPP_NAME    = 'TambalFinder'      
        
        // Cek di Azure Portal > Resource groups > Nama RG kamu
        RESOURCE_GROUP = 'RG-TambalFinder-2026'
    }

    stages {
        stage('Checkout Code') {
            steps {
                // Mengambil kodingan terbaru dari GitHub
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo '--- Mulai Membangun Image ---'
                    // Kita pakai tag 'latestjens' biar konsisten
                    bat "docker build -t %REGISTRY_URL%/%IMAGE_NAME%:latestjens ."
                }
            }
        }

        stage('Login to ACR') {
            steps {
                script {
                    echo '--- Login ke Azure Container Registry ---'
                    // Mengambil username & password dari Jenkins Credentials
                    withCredentials([usernamePassword(credentialsId: DOCKER_CRED_ID, usernameVariable: 'ACR_USER', passwordVariable: 'ACR_PASS')]) {
                        bat "docker login %REGISTRY_URL% -u %ACR_USER% -p %ACR_PASS%"
                    }
                }
            }
        }

        stage('Push Image') {
            steps {
                script {
                    echo '--- Mengirim Image ke Cloud (ACR) ---'
                    bat "docker push %REGISTRY_URL%/%IMAGE_NAME%:latestjens"
                }
            }
        }

        stage('Deploy to Azure Web App') {
            steps {
                script {
                    echo "--- Memicu Deployment via Webhook ---"
                    
                    // Ganti URL_WEBHOOK_DARI_AZURE dengan URL panjang yang Anda copy tadi
                    // Tips: Sebaiknya URL ini disimpan di Jenkins Credentials (Secret Text) agar aman
                    // Tapi untuk tes, tempel langsung tidak apa-apa.
                    def webhookUrl = "https://$TambalFinderr:S7x3L1zxHC0suix51Jv96gchABGDqi4HZLsihtgWdbfoi51W0rPPR42Z9M3l@tambalfinderr.scm.azurewebsites.net/api/registry/webhook"
                    
                    // Perintah curl untuk 'mencolek' Azure
                    // Azure akan otomatis pull image 'latestjens' dan restart sendiri
                    bat "curl -X POST \"${webhookUrl}\""
                }
            }
        }

    post {
        always {
            echo '--- Membersihkan Sisa Build ---'
            // Logout dan hapus image di laptop agar harddisk tidak penuh
            bat "docker logout %REGISTRY_URL%"
            bat "docker rmi %REGISTRY_URL%/%IMAGE_NAME%:latestjens || exit 0"
        }
    }
}
